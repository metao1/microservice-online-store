name: Test Coverage Validation

on:
  pull_request:
    branches:
      - master
    paths:
      - 'inventory-microservice/src/**'
      - 'order-microservice/src/**'
      - 'payment-microservice/src/**'
      - 'kafka-lib/src/**'
      - 'shared-kernel/src/**'
      - 'shared-test/src/**'
      - '.github/workflows/test-coverage.yml'

jobs:
  test-coverage:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4.2.2

      - name: Set up JDK 21
        uses: actions/setup-java@v4.7.1
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Generate inventory-microservice test coverage report
        run: ./gradlew inventory-microservice:jacocoTestReport
      - name: Run order-microservice tests
        run: ./gradlew order-microservice:jacocoTestReport
      - name: Generate payment-microservice test coverage report
        run: ./gradlew payment-microservice:jacocoTestReport
      - name: Generate shared-kernel test coverage report
        run: ./gradlew shared-kernel:jacocoTestReport
      - name: Generate kafka-lib test coverage report
        run: ./gradlew kafka-lib:jacocoTestReport

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./inventory-microservice/build/reports/jacoco/test/jacocoTestReport.xml
          flags: inventory-microservice
          fail_ci_if_error: false

      - name: Comment PR with coverage status
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('./inventory-microservice/build/reports/jacoco/test/jacocoTestReport.xml', 'utf8');
            const match = report.match(/linerate="([^"]+)"/);
            const coverage = match ? (parseFloat(match[1]) * 100).toFixed(2) : 'unknown';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸ“Š **Test Coverage Report**\n\nâœ“ All tests passed\nðŸ“ˆ Coverage: ${coverage}%\n\n> See [plan-strengthenInventoryMicroserviceTestCoverage.prompt.md](../../plan-strengthenInventoryMicroserviceTestCoverage.prompt.md) for coverage improvement goals.`
            });

